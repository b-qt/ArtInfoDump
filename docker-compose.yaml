version: '3.8'

services:
  db-postgres:
    container_name: postgres_db
    image: postgres:latest
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: artdb
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d artdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  db-gui:
    container_name: pgadmin-container
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: pgadmin@pgadmin.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - 8080:80
    depends_on:
      - db-postgres

  app:
    container_name: art_data_getter
    build: .
    volumes:
      - ./app:/app
    depends_on:
      db-postgres:
        condition: service_healthy
      db-gui:
        condition: service_started
    environment:
      - DATABASE_USERNAME=myuser
      - DATABASE_PASSWORD=mypassword
      - DATABASE_NAME=artdb
      - DATABASE_HOST=db-postgres
      - DATABASE_PORT=5432
    command: >
      python main_getter.py --user myuser --password mypassword --host db-postgres --port 5432 --db artdb --table_name exhibitions
    restart: on-failure

# To run the stack:
# 1. Ensure Docker and Docker Compose are installed on your machine.
# 2. Navigate to the directory containing this docker-compose.yaml file.
# 3. Run the following command to build and start the services:
#    docker-compose up --build -d 
# 4. Access pgAdmin GUI at http://localhost:8080 with the credentials.
# 5. Monitor logs with: docker-compose logs -f app
# 6. To stop the services, run: docker-compose down
# 7. To rebuild the app service after code changes, use:
#    docker-compose up --build -d app

# Restart the entire stack with: docker-compose down && docker-compose up --build -d
# Confirm services are running with: docker-compose ps
#     command: >
#      sh -c "ls -lah /app && \
#      python main_getter.py --user myuser \
#                           --password mypassword \
#                           --host db-postgres \
#                           --port 5432 \
#                           --db artdb \
#                           --table_name exhibitions"